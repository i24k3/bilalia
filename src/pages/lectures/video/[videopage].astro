---
export const prerender = false;

import BaseLayout from "../../../layout/BaseLayout.astro";
import VideoCard from "../../../sections/lectures/VideoCard.astro";
import Pagination from "../../../components/Pagination.astro";
import { supabase } from "../../../lib/supabase.js";

const itemsPerPage = 3;
const videoPage = parseInt(Astro.params.videopage) || 1;
const videoStart = (videoPage - 1) * itemsPerPage;
const videoEnd = videoStart + itemsPerPage - 1;

let videoLectures = [];
let videoTotalPages = 0;
let fetchError = null;

// Single fetch for video lectures + count
try {
  const { data, count, error } = await supabase
    .from("lectures")
    .select("*", { count: "exact" })
    .eq("type", "video")
    .order("search_id", { ascending: true })
    .range(videoStart, videoEnd);

  if (error) throw error;

  videoLectures = data ?? [];
  videoTotalPages = count ? Math.ceil(count / itemsPerPage) : 0;

} catch (err) {
  fetchError = err;
  console.error("[supabase]: video lectures fetch failed!", {
    message: err.message,
    details: err.details,
    hint: err.hint,
  });
}

const pageData = {
  heading: "Lectures",
  subHeading: "Engage with our latest audio and video lectures, curated for your learning journey",
};
---

<BaseLayout>
  <main class="min-h-screen bg-gray-50 pt-36 pb-24">

    <!-- HEADER -->
    <div class="max-w-4xl mx-auto px-6 text-center mb-16">
      <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold text-gray-900 leading-snug">
        {pageData.heading}
      </h1>
      <p class="mt-12 text-gray-500 text-base sm:text-lg md:text-xl max-w-2xl mx-auto leading-relaxed">
        {pageData.subHeading}
      </p>
    </div>

    <!-- VIDEO LECTURES -->
    <section class="max-w-4xl mx-auto px-6 flex flex-col gap-8">
      {fetchError && (
        <div class="w-full text-center mt-12 mb-8">
          <p class="text-red-500 text-lg">
            Unable to load video lectures. Please try again later.
          </p>
        </div>
      )}

      {!fetchError && videoLectures.length === 0 && (
        <div class="w-full text-center mt-12 mb-8">
          <p class="text-gray-400 text-lg">No video lectures available at the moment.</p>
        </div>
      )}

      {!fetchError && videoLectures.length > 0 && (
        videoLectures.map((lecture) => (
          <VideoCard
            lecture={lecture}
            class="w-full bg-white rounded-3xl border border-gray-200 shadow-sm sm:shadow-md overflow-hidden"
          />
        ))
      )}
    </section>

    <!-- PAGINATION -->
    {!fetchError && videoTotalPages > 1 && (
      <div class="mt-16 flex justify-center">
        <Pagination 
          totalPages={videoTotalPages} 
          currentPage={videoPage} 
          baseUrl="/lectures/video"
          class="text-gray-700" 
        />
      </div>
    )}

  </main>
</BaseLayout>

