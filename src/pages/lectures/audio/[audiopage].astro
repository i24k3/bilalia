---
export const prerender = false;

import BaseLayout from "../../../layout/BaseLayout.astro";
import AudioCard from "../../../sections/lectures/AudioCard.astro";
import Pagination from "../../../componets/Pagination.astro";

import { supabase } from "../../../lib/supabase.js";

const itemsPerPage = 3;
const audioPage = parseInt(Astro.params.audiopage) || 1;
const audioStart = (audioPage - 1) * itemsPerPage;
const audioEnd = audioStart + itemsPerPage - 1;

let audioLectures = [];
let audioTotalPages = 0;
let fetchError = null;

// Single fetch for audio lectures + count
try {
  const { data, count, error } = await supabase
    .from("lectures")
    .select("*", { count: "exact" })
    .eq("type", "audio")
    .order("search_id", { ascending: true })
    .range(audioStart, audioEnd);

  if (error) throw error;

  audioLectures = data ?? [];
  audioTotalPages = count ? Math.ceil(count / itemsPerPage) : 0;

} catch (err) {
  fetchError = err;
  console.error("[supabase]: audio lectures fetch failed!", {
    message: err.message,
    details: err.details,
    hint: err.hint,
  });
}

const pageData = {
  heading: "Lectures",
  subHeading: "Engage with our latest audio and video lectures, curated for your learning journey",
};
---

<BaseLayout>
  <main class="min-h-screen bg-gray-50 pt-36 pb-24">
    
    {/* HEADER */}
    <div class="max-w-4xl mx-auto px-6 text-center">
      <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight text-gray-900">
        {pageData.heading}
      </h1>
      <p class="mt-12 text-lg md:text-xl text-gray-500 max-w-2xl mx-auto">
        {pageData.subHeading}
      </p>
    </div>

    {/* AUDIO LECTURES SECTION */}
    <section
      id="audios-section"
      class="max-w-7xl mx-auto px-6 mt-16 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"
    >
      {fetchError && (
        <div class="col-span-full text-center mt-12 mb-8">
          <p class="text-red-500 text-lg">
            Unable to load audio lectures. Please try again later.
          </p>
        </div>
      )}

      {!fetchError && audioLectures.length === 0 && (
        <div class="col-span-full text-center mt-12 mb-8">
          <p class="text-gray-400 text-lg">No audio lectures available at the moment.</p>
        </div>
      )}

      {!fetchError && audioLectures.length > 0 && (
        audioLectures.map((lecture) => (
          <AudioCard
            lecture={lecture}
            class="w-full shadow-lg rounded-2xl border border-gray-200 transition hover:shadow-2xl"
          />
        ))
      )}
    </section>

    {/* PAGINATION */}
    {!fetchError && audioTotalPages > 1 && (
      <div class="mt-16 flex justify-center">
        <Pagination totalPages={audioTotalPages} currentPage={audioPage} baseUrl="/lectures/audio" />
      </div>
    )}

  </main>
</BaseLayout>


