---
export const prerender = false;
import { supabase } from "../../lib/supabase.js";
import Card from "./../../components/Card.astro";
import BaseLayout from "../../layout/BaseLayout.astro";

const itemsPerPage = 3;
const eventsPage = parseInt(Astro.params.eventspage) || 1;
const start = (eventsPage - 1) * itemsPerPage;
const end = start + itemsPerPage - 1;

let events = [];
let totalPages = 0;
let fetchError = null;

// Single fetch for events + count
try {
  const { data, count, error } = await supabase
    .from("events")
    .select("*", { count: "exact" })
    .order("search_id", { ascending: true })
    .range(start, end);

  if (error) throw error;

  events = data ?? [];
  totalPages = count ? Math.ceil(count / itemsPerPage) : 0;

} catch (err) {
  fetchError = err;
  console.error("[supabase]: events fetch failed!", {
    message: err.message,
    details: err.details,
    hint: err.hint,
  });
}

const pageData = {
  heading: "Latest Events",
  subHeading: "Stay updated with Darul Uloom Bilaliya",
};
---

<BaseLayout>

  <main class="min-h-screen bg-linear-to-b from-gray-50 to-white pt-36 pb-24">
    <div class="max-w-7xl mx-auto px-6 text-center">

      <!-- Header -->
      <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight text-gray-900">{pageData.heading}</h1>
      <p class="mt-4 text-lg md:text-xl text-gray-500 max-w-xl mx-auto">{pageData.subHeading}</p>

      <!-- Events Grid -->
      {fetchError && (
        <p class="text-red-500 mt-12 text-lg">
          Unable to load events. Please try again later.
        </p>
      )}

      {!fetchError && events.length === 0 && (
        <p class="text-gray-400 mt-12 text-lg">
          Subhanallah! No events available at the moment.
        </p>
      )}

      {!fetchError && events.length > 0 && (
        <div class="grid gap-10 mt-16 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
          {events.map((event) => (
            <Card notification={event} path="event" />
          ))}
        </div>
      )}

      <!-- Pagination -->
      {!fetchError && totalPages > 1 && (
        <div class="flex justify-center mt-16 gap-3 flex-wrap">
          {Array.from({ length: totalPages }, (_, i) => {
            const pageNumber = i + 1;
            const isActive = pageNumber === eventsPage;
            return (
              <a
                class={`px-5 py-2 rounded-xl text-sm font-medium transition-all duration-200 
                  ${isActive ? "bg-gray-900 text-white shadow-lg" : "bg-gray-100 text-gray-700 hover:bg-gray-200"}`}
                href={`/events/${pageNumber}`}
              >
                {pageNumber}
              </a>
            );
          })}
        </div>
      )}

    </div>
  </main>

</BaseLayout>

