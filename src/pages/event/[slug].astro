---

import BaseLayout from "../../layout/BaseLayout.astro";
import NotFound from "../../componets/NotFound.astro";
import ReadContent from "../../componets/ReadContents.astro";

import { supabase } from "../../lib/supabase.js";
import DOMPurify from "isomorphic-dompurify";

const { slug } = Astro.params;

const { data: event, error } = await supabase
  .from("events")
  .select("*")
  .eq("url_slug", slug)
  .single();

const button404 = [
  { href: "/", text: "Goto Home", type: "primary" },
  { href: "/events/1", text: "Explore Events", type: "tertiary" },
];

if (error) console.error(error);

const formattedDate = event ? new Date(event.date_onsite).toLocaleDateString("en-GB", { day: "numeric", month: "long", year: "numeric" }) : null;
const safeOpening = event?.opening ? DOMPurify.sanitize(event.opening) : "";
const safeBody = event?.body ? DOMPurify.sanitize(event.body) : "";
const images = event?.event_image_url || [];
---
<BaseLayout>
  {!event ? (
    <NotFound buttons={button404} />
  ) : (
    <ReadContent
      title={event.title}
      category={event.category}
      date={formattedDate}
      opening={safeOpening}
      body={safeBody}
      images={images}
      backHref="/events/1"
      backText="All Events"
    />
  )}
</BaseLayout>

